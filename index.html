<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Illuminati EGN Portal - Complete System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --illuminati-gold: #FFD700;
            --illuminati-orange: #FFA500;
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --dark-border: #334155;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
        }

        .illuminati-gradient {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }

        .illuminati-button {
            background: linear-gradient(145deg, #FFD700, #FFA500);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .illuminati-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }

        .illuminati-shadow {
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);
        }

        .dark-mode {
            background: linear-gradient(135deg, #0f172a 0%, #000000 100%);
            color: white;
        }

        .light-mode {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #1e293b;
        }

        .sidebar {
            width: 280px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: rgba(30, 41, 55, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 215, 0, 0.2);
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-item {
            padding: 1rem 1.5rem;
            margin: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-item:hover {
            background: rgba(255, 215, 0, 0.1);
            transform: translateX(5px);
        }

        .sidebar-item.active {
            background: rgba(255, 215, 0, 0.2);
            border-left: 4px solid #FFD700;
        }

        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: #1e293b;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .stat-card {
            background: rgba(30, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }

        .member-card {
            background: rgba(30, 41, 55, 0.9);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.5);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 0.5rem;
            color: white;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-paid {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .badge-partial {
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
            border: 1px solid #fb923c;
        }

        .badge-pending {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            transition: width 0.5s ease;
        }

        .image-preview {
            width: 100%;
            max-width: 200px;
            height: 200px;
            border-radius: 0.5rem;
            object-fit: cover;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .receipt-card, .id-card-preview {
            background: white;
            color: black;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .platform-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0f172a 0%, #000000 100%);
        }

        .login-card {
            background: rgba(30, 41, 55, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 1.5rem;
            padding: 3rem;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .spinner {
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top: 3px solid #FFD700;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="dark-mode">
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="text-center mb-8">
                <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/72d629e9a_IlluminatiEyewithSouthAfricanFlag.png" 
                     alt="Illuminati Logo" 
                     class="h-24 w-24 mx-auto mb-6 bg-white p-2 rounded-xl illuminati-shadow">
                <h1 class="text-4xl font-bold text-yellow-400 mb-2">ILLUMINATI</h1>
                <h2 class="text-xl font-semibold text-white mb-2">EGN PORTAL</h2>
                <p class="text-gray-400">Elite Global Network Management System</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i data-lucide="lock" class="inline w-4 h-4 mr-2"></i>
                        Admin Password
                    </label>
                    <input type="password" 
                           id="loginPassword" 
                           placeholder="Enter admin password"
                           class="input-field"
                           onkeypress="handleLoginKeyPress(event)">
                </div>
                
                <button onclick="handleLogin()" 
                        class="illuminati-button w-full py-4 rounded-lg text-black font-bold text-lg flex items-center justify-center gap-2">
                    <i data-lucide="shield-check" class="w-5 h-5"></i>
                    Access Portal
                </button>

                <div class="text-center text-sm text-gray-500">
                    <i data-lucide="info" class="inline w-4 h-4"></i>
                    Authorized personnel only
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        
        <!-- Sidebar Navigation -->
        <div id="sidebar" class="sidebar scrollbar-hide">
            <!-- Sidebar Header -->
            <div class="p-6 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/72d629e9a_IlluminatiEyewithSouthAfricanFlag.png" 
                         alt="Logo" 
                         class="h-12 w-12 bg-white p-1 rounded-lg">
                    <div>
                        <h2 class="font-bold text-lg text-white">ILLUMINATI</h2>
                        <p class="text-xs text-yellow-400">EGN PORTAL</p>
                    </div>
                </div>
            </div>

            <!-- Navigation Items -->
            <div class="py-4">
                <p class="px-6 text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Portal Navigation</p>
                
                <div class="sidebar-item active" onclick="navigateTo('dashboard')">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="font-medium">Dashboard</span>
                </div>

                <div class="sidebar-item" onclick="navigateTo('members')">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="font-medium">Members</span>
                </div>

                <div class="sidebar-item" onclick="navigateTo('joining')">
                    <i data-lucide="dollar-sign" class="w-5 h-5"></i>
                    <span class="font-medium">Joining Threshold</span>
                </div>

                <div class="sidebar-item" onclick="navigateTo('receipt')">
                    <i data-lucide="receipt" class="w-5 h-5"></i>
                    <span class="font-medium">Payment Receipt</span>
                </div>

                <div class="sidebar-item" onclick="navigateTo('idcard')">
                    <i data-lucide="credit-card" class="w-5 h-5"></i>
                    <span class="font-medium">ID Card Generator</span>
                </div>

                <div class="sidebar-item" onclick="navigateTo('payment')">
                    <i data-lucide="banknote" class="w-5 h-5"></i>
                    <span class="font-medium">Payment Installation</span>
                </div>

                <div class="sidebar-item" onclick="navigateTo('settings')">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="font-medium">Settings</span>
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="absolute bottom-0 left-0 right-0 p-6 border-t border-gray-700 bg-gray-900">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-sm text-gray-400">Theme</span>
                    <button onclick="toggleTheme()" class="p-2 bg-gray-800 rounded-lg hover:bg-gray-700">
                        <i data-lucide="moon" id="themeIcon" class="w-5 h-5 text-yellow-400"></i>
                    </button>
                </div>
                <button onclick="logout()" 
                        class="w-full px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-bold flex items-center justify-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Logout
                </button>
            </div>
        </div>

        <!-- Mobile Menu Toggle -->
        <button id="mobileMenuBtn" 
                onclick="toggleMobileSidebar()" 
                class="fixed top-4 left-4 z-50 md:hidden illuminati-button p-3 rounded-lg">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>

        <!-- Main Content Area -->
        <div id="mainContent" class="main-content">
            
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-section active">
                <div class="mb-8">
                    <h1 class="text-4xl font-bold text-white mb-2">Dashboard Overview</h1>
                    <p class="text-gray-400">Complete analytics and member statistics</p>
                </div>

                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-gray-400 text-sm mb-1">Total Members</p>
                                <h3 id="statTotalMembers" class="text-3xl font-bold text-white">0</h3>
                            </div>
                            <div class="p-3 bg-blue-900 rounded-lg">
                                <i data-lucide="users" class="w-8 h-8 text-blue-400"></i>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            <i data-lucide="trending-up" class="inline w-3 h-3"></i>
                            Active registrations
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-gray-400 text-sm mb-1">Total Collected</p>
                                <h3 id="statTotalCollected" class="text-3xl font-bold text-green-400">R 0</h3>
                            </div>
                            <div class="p-3 bg-green-900 rounded-lg">
                                <i data-lucide="wallet" class="w-8 h-8 text-green-400"></i>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            <i data-lucide="check-circle" class="inline w-3 h-3"></i>
                            Successful payments
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-gray-400 text-sm mb-1">Outstanding</p>
                                <h3 id="statOutstanding" class="text-3xl font-bold text-orange-400">R 0</h3>
                            </div>
                            <div class="p-3 bg-orange-900 rounded-lg">
                                <i data-lucide="alert-circle" class="w-8 h-8 text-orange-400"></i>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            <i data-lucide="clock" class="inline w-3 h-3"></i>
                            Pending payments
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-gray-400 text-sm mb-1">Expected Total</p>
                                <h3 id="statExpectedTotal" class="text-3xl font-bold text-blue-400">R 0</h3>
                            </div>
                            <div class="p-3 bg-blue-900 rounded-lg">
                                <i data-lucide="target" class="w-8 h-8 text-blue-400"></i>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            <i data-lucide="bar-chart" class="inline w-3 h-3"></i>
                            Total revenue goal
                        </div>
                    </div>
                </div>

                <!-- Payment Status Distribution -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="stat-card">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-5 h-5 text-yellow-400"></i>
                            Payment Status Distribution
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-400">Paid</span>
                                    <span id="paidCount" class="text-green-400 font-semibold">0 members</span>
                                </div>
                                <div class="progress-bar">
                                    <div id="paidProgress" class="progress-fill" style="width: 0%; background: #22c55e;"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-400">Partial</span>
                                    <span id="partialCount" class="text-orange-400 font-semibold">0 members</span>
                                </div>
                                <div class="progress-bar">
                                    <div id="partialProgress" class="progress-fill" style="width: 0%; background: #fb923c;"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-400">Pending</span>
                                    <span id="pendingCount" class="text-red-400 font-semibold">0 members</span>
                                </div>
                                <div class="progress-bar">
                                    <div id="pendingProgress" class="progress-fill" style="width: 0%; background: #ef4444;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-5 h-5 text-yellow-400"></i>
                            Top Platforms
                        </h3>
                        <div id="platformStats" class="space-y-3">
                            <!-- Platform stats will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Recent Members -->
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i data-lucide="user-check" class="w-5 h-5 text-yellow-400"></i>
                            Recent Registrations
                        </h3>
                        <button onclick="navigateTo('members')" 
                                class="text-yellow-400 hover:text-yellow-300 text-sm font-semibold flex items-center gap-1">
                            View All
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="recentMembers" class="space-y-3">
                        <!-- Recent members will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Members Page -->
            <div id="membersPage" class="page-section">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-4xl font-bold text-white mb-2">Member Management</h1>
                        <p class="text-gray-400">View and manage all registered members</p>
                    </div>
                    <button onclick="showAddMemberModal()" 
                            class="illuminati-button px-6 py-3 rounded-lg text-black font-bold flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-5 h-5"></i>
                        Add New Member
                    </button>
                </div>

                <!-- Search and Filter -->
                <div class="stat-card mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                                <input type="text" 
                                       id="searchMembers" 
                                       onkeyup="filterMembers()" 
                                       placeholder="Search by name, location, platform, email, phone..."
                                       class="input-field pl-12">
                            </div>
                        </div>
                        <div>
                            <select id="filterStatus" onchange="filterMembers()" class="input-field">
                                <option value="all">All Status</option>
                                <option value="paid">Paid</option>
                                <option value="partial">Partial</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Members Grid -->
                <div id="membersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Members will be loaded here -->
                </div>
            </div>

            <!-- Joining Threshold Page -->
            <div id="joiningPage" class="page-section">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-4xl font-bold text-white mb-2">Joining Threshold</h1>
                        <p class="text-gray-400">Elite Global Network Requirements</p>
                    </div>
                    <button onclick="downloadJoiningThreshold()" 
                            class="illuminati-button px-6 py-3 rounded-lg text-black font-bold flex items-center gap-2">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        Download
                    </button>
                </div>

                <div class="stat-card mb-6">
                    <h3 class="text-xl font-bold text-white mb-4">Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Joining Fee (R)</label>
                            <input type="number" id="joiningFee" value="1000" class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">WhatsApp Number</label>
                            <input type="text" id="whatsappContact" value="063 914 5113" class="input-field">
                        </div>
                    </div>
                    <button onclick="saveJoiningSettings()" class="illuminati-button px-6 py-3 rounded-lg text-black font-bold mt-4">
                        <i data-lucide="save" class="inline w-4 h-4 mr-2"></i>
                        Save Settings
                    </button>
                </div>

                <div id="joiningThresholdCard" class="receipt-card mx-auto max-w-2xl">
                    <!-- Joining threshold content will be rendered here -->
                </div>
            </div>

            <!-- Payment Receipt Page -->
            <div id="receiptPage" class="page-section">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-4xl font-bold text-white mb-2">Payment Receipt</h1>
                        <p class="text-gray-400">Generate payment acceptance receipts</p>
                    </div>
                    <button onclick="downloadReceipt()" 
                            class="illuminati-button px-6 py-3 rounded-lg text-black font-bold flex items-center gap-2">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        Download Receipt
                    </button>
                </div>

                <div class="stat-card mb-6">
                    <h3 class="text-xl font-bold text-white mb-4">Select Member</h3>
                    <select id="receiptMember" onchange="updateReceipt()" class="input-field">
                        <option value="">Select a member</option>
                    </select>
                </div>

                <div id="receiptCard" class="receipt-card mx-auto max-w-2xl">
                    <!-- Receipt content will be rendered here -->
                </div>
            </div>

            <!-- ID Card Page -->
            <div id="idcardPage" class="page-section">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-4xl font-bold text-white mb-2">ID Card Generator</h1>
                        <p class="text-gray-400">Create official member ID cards</p>
                    </div>
                    <button onclick="downloadIDCard()" 
                            class="illuminati-button px-6 py-3 rounded-lg text-black font-bold flex items-center gap-2">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        Download ID Card
                    </button>
                </div>

                <div class="stat-card mb-6">
                    <h3 class="text-xl font-bold text-white mb-4">Select Member & Position</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Member</label>
                            <select id="idcardMember" onchange="updateIDCard()" class="input-field">
                                <option value="">Select a member</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Position</label>
                            <input type="text" id="idcardPosition" onkeyup="updateIDCard()" class="input-field" placeholder="e.g., Elite Member">
                        </div>
                    </div>
                </div>

                <div class="flex justify-center">
                    <div id="idCardPreview" class="id-card-preview max-w-md w-full">
                        <!-- ID card will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Payment Installation Page -->
            <div id="paymentPage" class="page-section">
                <div class="mb-8">
                    <h1 class="text-4xl font-bold text-white mb-2">Payment Installation</h1>
                    <p class="text-gray-400">Record and track payment installations</p>
                </div>

                <div class="stat-card max-w-3xl mx-auto">
                    <h3 class="text-xl font-bold text-white mb-6">Payment Installation Form</h3>
                    <form id="paymentForm" onsubmit="savePaymentInstallation(event)" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Payer Name *</label>
                                <input type="text" id="payerName" required class="input-field">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Payer Phone *</label>
                                <input type="tel" id="payerPhone" required class="input-field">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Payment Method *</label>
                            <select id="paymentMethod" required class="input-field">
                                <option value="">Select method</option>
                                <option value="pep">PEP Store</option>
                                <option value="capitec">Capitec</option>
                                <option value="cash">Cash</option>
                                <option value="eft">EFT</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Withdrawal Number *</label>
                                <input type="text" id="withdrawalNumber" required class="input-field" maxlength="10">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">PIN *</label>
                                <input type="text" id="withdrawalPin" required class="input-field" maxlength="4">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Amount (R) *</label>
                                <input type="number" id="paymentAmount" required step="0.01" class="input-field">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Location</label>
                                <input type="text" id="paymentLocation" class="input-field">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Upload Payer Image</label>
                            <input type="file" id="payerImageFile" accept="image/*" onchange="handlePayerImageUpload(event)" class="input-field">
                            <img id="payerImagePreview" class="image-preview mt-2" style="display: none;">
                        </div>

                        <button type="submit" class="illuminati-button w-full py-4 rounded-lg text-black font-bold text-lg flex items-center justify-center gap-2">
                            <i data-lucide="save" class="w-5 h-5"></i>
                            Save Payment Installation
                        </button>
                    </form>
                </div>

                <!-- Payment History -->
                <div class="mt-8 stat-card">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="history" class="w-5 h-5 text-yellow-400"></i>
                        Payment History
                    </h3>
                    <div id="paymentHistory" class="space-y-3">
                        <!-- Payment history will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settingsPage" class="page-section">
                <div class="mb-8">
                    <h1 class="text-4xl font-bold text-white mb-2">System Settings</h1>
                    <p class="text-gray-400">Configure application settings</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="stat-card">
                        <h3 class="text-xl font-bold text-white mb-4">Payment Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Default Joining Fee (R)</label>
                                <input type="number" id="settingsJoiningFee" value="1000" class="input-field">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Default Goat Payment (R)</label>
                                <input type="number" id="settingsGoatPayment" value="3000" class="input-field">
                            </div>
                            <button onclick="saveSettings()" class="illuminati-button w-full py-3 rounded-lg text-black font-bold">
                                <i data-lucide="save" class="inline w-4 h-4 mr-2"></i>
                                Save Payment Settings
                            </button>
                        </div>
                    </div>

                    <div class="stat-card">
                        <h3 class="text-xl font-bold text-white mb-4">Data Management</h3>
                        <div class="space-y-4">
                            <button onclick="exportData()" class="w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold flex items-center justify-center gap-2">
                                <i data-lucide="download-cloud" class="w-5 h-5"></i>
                                Export All Data (JSON)
                            </button>
                            <button onclick="clearAllData()" class="w-full px-6 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-bold flex items-center justify-center gap-2">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                Clear All Data
                            </button>
                            <p class="text-xs text-gray-500 text-center">
                                <i data-lucide="alert-triangle" class="inline w-3 h-3"></i>
                                Warning: Clearing data cannot be undone
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Add/Edit Member Modal -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-yellow-400 flex items-center gap-2">
                    <i data-lucide="user-plus" class="w-6 h-6"></i>
                    <span id="memberModalTitle">Add New Member</span>
                </h2>
                <button onclick="closeMemberModal()" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <form id="memberForm" onsubmit="saveMember(event)" class="space-y-4">
                <input type="hidden" id="memberId">

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Full Name *</label>
                    <input type="text" id="memberFullName" required class="input-field">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Profile Image</label>
                    <input type="file" id="memberImageFile" accept="image/*" onchange="handleMemberImageUpload(event)" class="input-field">
                    <img id="memberImagePreview" class="image-preview mt-2" style="display: none;">
                    <input type="hidden" id="memberProfileImage">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Payment Amount (R) *</label>
                        <input type="number" id="memberPaymentAmount" required step="0.01" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Amount Paid (R)</label>
                        <input type="number" id="memberAmountPaid" value="0" step="0.01" class="input-field">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Payment Status</label>
                    <select id="memberPaymentStatus" class="input-field">
                        <option value="pending">Pending</option>
                        <option value="partial">Partial</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Location</label>
                    <input type="text" id="memberLocation" class="input-field">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Platform Found</label>
                    <select id="memberPlatform" class="input-field">
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="tiktok">TikTok</option>
                        <option value="beelze">Beelze</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="moyaapp">Moya App</option>
                        <option value="streamx">StreamX</option>
                        <option value="streamxchat">StreamXChat</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">WhatsApp Number</label>
                        <input type="tel" id="memberWhatsapp" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                        <input type="email" id="memberEmail" class="input-field">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Position/Title</label>
                    <input type="text" id="memberPosition" class="input-field" placeholder="e.g., Elite Member, Regional Leader">
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeMemberModal()" 
                            class="flex-1 px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="flex-1 illuminati-button px-6 py-3 rounded-lg text-black font-bold">
                        <i data-lucide="save" class="inline w-4 h-4 mr-2"></i>
                        Save Member
                    </button>
                </div>
            </form>
        </div>
    </div>



    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDDMsvRTz9nPGDk8Ob_FPRc5Boov2FVt9w",
            authDomain: "egn-portal.firebaseapp.com",
            projectId: "egn-portal",
            storageBucket: "egn-portal.firebasestorage.app",
            messagingSenderId: "88252271549",
            appId: "1:88252271549:web:80aa211a420e205c1720d4",
            measurementId: "G-KYMBME9RDQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.query = query;
        window.orderBy = orderBy;
        window.limit = limit;

        console.log('Firebase initialized successfully');
    </script>

    <script>
        const ADMIN_PASSWORD = 'VNAXXTTM';
        let allMembers = [];
        let allPayments = [];
        let isDarkMode = true;
        let currentPage = 'dashboard';

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            lucide.createIcons();
        });

        // Authentication
        function checkAuth() {
            const isAuthenticated = localStorage.getItem('illuminati_auth') === 'true';
            if (isAuthenticated) {
                showMainApp();
            }
        }

        function handleLoginKeyPress(event) {
            if (event.key === 'Enter') {
                handleLogin();
            }
        }

        function handleLogin() {
            const password = document.getElementById('loginPassword').value;
            if (password === ADMIN_PASSWORD) {
                localStorage.setItem('illuminati_auth', 'true');
                showMainApp();
            } else {
                alert('âŒ Incorrect Password! Access Denied.');
                document.getElementById('loginPassword').value = '';
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadAllData();
            lucide.createIcons();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('illuminati_auth');
                location.reload();
            }
        }

        // Theme Toggle
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.body.classList.toggle('light-mode', !isDarkMode);
            const icon = document.getElementById('themeIcon');
            icon.setAttribute('data-lucide', isDarkMode ? 'moon' : 'sun');
            lucide.createIcons();
        }

        // Navigation
        function navigateTo(page) {
            currentPage = page;
            
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const pageMap = {
                'dashboard': 'dashboardPage',
                'members': 'membersPage',
                'joining': 'joiningPage',
                'receipt': 'receiptPage',
                'idcard': 'idcardPage',
                'payment': 'paymentPage',
                'settings': 'settingsPage'
            };
            
            document.getElementById(pageMap[page]).classList.add('active');
            event.target.closest('.sidebar-item').classList.add('active');
            
            if (page === 'dashboard') {
                updateDashboard();
            } else if (page === 'members') {
                displayMembers(allMembers);
            } else if (page === 'receipt') {
                populateMemberSelect('receiptMember');
                updateReceipt();
            } else if (page === 'idcard') {
                populateMemberSelect('idcardMember');
                updateIDCard();
            } else if (page === 'joining') {
                renderJoiningThreshold();
            } else if (page === 'payment') {
                loadPaymentHistory();
            }
            
            lucide.createIcons();
        }

        function toggleMobileSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }

        // Data Loading
        async function loadAllData() {
            showLoading();
            try {
                await Promise.all([
                    loadMembers(),
                    loadPayments(),
                    loadSettings()
                ]);
                updateDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data. Check console for details.');
            } finally {
                hideLoading();
            }
        }

        async function loadMembers() {
            try {
                const q = window.query(window.collection(window.db, 'members'), window.orderBy('createdAt', 'desc'));
                const querySnapshot = await window.getDocs(q);
                allMembers = [];
                querySnapshot.forEach((doc) => {
                    allMembers.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${allMembers.length} members`);
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }

        async function loadPayments() {
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'payments'));
                allPayments = [];
                querySnapshot.forEach((doc) => {
                    allPayments.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${allPayments.length} payments`);
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        }

        async function loadSettings() {
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'settings'));
                if (!querySnapshot.empty) {
                    const settingsDoc = querySnapshot.docs[0];
                    const settings = settingsDoc.data();
                    document.getElementById('joiningFee').value = settings.joiningFee || 1000;
                    document.getElementById('whatsappContact').value = settings.whatsappNumber || '063 914 5113';
                    document.getElementById('settingsJoiningFee').value = settings.joiningFee || 1000;
                    document.getElementById('settingsGoatPayment').value = settings.goatPayment || 3000;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Dashboard Functions
        function updateDashboard() {
            const totalMembers = allMembers.length;
            const totalCollected = allMembers.reduce((sum, m) => sum + (parseFloat(m.amountPaid) || 0), 0);
            const expectedTotal = allMembers.reduce((sum, m) => sum + (parseFloat(m.paymentAmount) || 0), 0);
            const totalOutstanding = expectedTotal - totalCollected;

            document.getElementById('statTotalMembers').textContent = totalMembers;
            document.getElementById('statTotalCollected').textContent = `R ${totalCollected.toFixed(2)}`;
            document.getElementById('statOutstanding').textContent = `R ${totalOutstanding.toFixed(2)}`;
            document.getElementById('statExpectedTotal').textContent = `R ${expectedTotal.toFixed(2)}`;

            const paidCount = allMembers.filter(m => m.paymentStatus === 'paid').length;
            const partialCount = allMembers.filter(m => m.paymentStatus === 'partial').length;
            const pendingCount = allMembers.filter(m => m.paymentStatus === 'pending').length;

            document.getElementById('paidCount').textContent = `${paidCount} members`;
            document.getElementById('partialCount').textContent = `${partialCount} members`;
            document.getElementById('pendingCount').textContent = `${pendingCount} members`;

            document.getElementById('paidProgress').style.width = totalMembers ? `${(paidCount / totalMembers) * 100}%` : '0%';
            document.getElementById('partialProgress').style.width = totalMembers ? `${(partialCount / totalMembers) * 100}%` : '0%';
            document.getElementById('pendingProgress').style.width = totalMembers ? `${(pendingCount / totalMembers) * 100}%` : '0%';

            updatePlatformStats();
            updateRecentMembers();
        }

        function updatePlatformStats() {
            const platformCounts = {};
            allMembers.forEach(m => {
                const platform = m.platformFound || 'other';
                platformCounts[platform] = (platformCounts[platform] || 0) + 1;
            });

            const sorted = Object.entries(platformCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const maxCount = sorted[0]?.[1] || 1;

            const html = sorted.map(([platform, count]) => {
                const percentage = (count / maxCount) * 100;
                return `
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-400 capitalize">${platform}</span>
                            <span class="text-white font-semibold">${count}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('platformStats').innerHTML = html || '<p class="text-gray-500 text-center">No data available</p>';
        }

        function updateRecentMembers() {
            const recent = allMembers.slice(0, 5);
            const html = recent.map(m => {
                const statusClass = m.paymentStatus === 'paid' ? 'badge-paid' : 
                                   m.paymentStatus === 'partial' ? 'badge-partial' : 'badge-pending';
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-900 rounded-lg">
                        <div class="flex items-center gap-3">
                            ${m.profileImage ? 
                                `<img src="${m.profileImage}" alt="${m.fullName}" class="w-10 h-10 rounded-full object-cover border-2 border-yellow-400">` :
                                `<div class="w-10 h-10 rounded-full bg-yellow-400 flex items-center justify-center text-black font-bold">${m.fullName?.charAt(0) || '?'}</div>`
                            }
                            <div>
                                <p class="text-white font-semibold">${m.fullName}</p>
                                <p class="text-gray-400 text-xs">${m.location || 'No location'}</p>
                            </div>
                        </div>
                        <span class="badge ${statusClass}">${m.paymentStatus?.toUpperCase() || 'PENDING'}</span>
                    </div>
                `;
            }).join('');

            document.getElementById('recentMembers').innerHTML = html || '<p class="text-gray-500 text-center">No members yet</p>';
        }

        // Member Functions
        function displayMembers(members) {
            const grid = document.getElementById('membersGrid');
            
            if (members.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <i data-lucide="users" class="w-20 h-20 text-gray-600 mx-auto mb-4"></i>
                        <p class="text-gray-400 text-lg mb-4">No members found</p>
                        <button onclick="showAddMemberModal()" class="illuminati-button px-6 py-3 rounded-lg text-black font-bold">
                            <i data-lucide="user-plus" class="inline w-5 h-5 mr-2"></i>
                            Add Your First Member
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            grid.innerHTML = members.map(member => {
                const outstanding = (parseFloat(member.paymentAmount) || 0) - (parseFloat(member.amountPaid) || 0);
                const statusClass = member.paymentStatus === 'paid' ? 'badge-paid' : 
                                   member.paymentStatus === 'partial' ? 'badge-partial' : 'badge-pending';
                
                return `
                    <div class="member-card">
                        <div class="flex items-start gap-4 mb-4">
                            ${member.profileImage ? 
                                `<img src="${member.profileImage}" alt="${member.fullName}" class="w-16 h-16 rounded-full object-cover border-2 border-yellow-400">` :
                                `<div class="w-16 h-16 rounded-full bg-yellow-400 flex items-center justify-center text-black font-bold text-2xl">
                                    ${member.fullName?.charAt(0) || '?'}
                                </div>`
                            }
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-lg text-white truncate">${member.fullName || 'Unknown'}</h3>
                                ${member.position ? `<p class="text-yellow-400 text-sm truncate">${member.position}</p>` : ''}
                                <span class="badge ${statusClass} mt-1">${member.paymentStatus?.toUpperCase() || 'PENDING'}</span>
                            </div>
                        </div>

                        <div class="space-y-2 text-sm mb-4">
                            ${member.location ? `
                                <div class="flex items-center gap-2 text-gray-300">
                                    <i data-lucide="map-pin" class="w-4 h-4 flex-shrink-0"></i>
                                    <span class="truncate">${member.location}</span>
                                </div>
                            ` : ''}
                            ${member.platformFound ? `
                                <div class="flex items-center gap-2 text-gray-300">
                                    <i data-lucide="globe" class="w-4 h-4 flex-shrink-0"></i>
                                    <span class="capitalize truncate">${member.platformFound}</span>
                                </div>
                            ` : ''}
                            ${member.whatsappNumber ? `
                                <div class="flex items-center gap-2 text-gray-300">
                                    <i data-lucide="phone" class="w-4 h-4 flex-shrink-0"></i>
                                    <span class="truncate">${member.whatsappNumber}</span>
                                </div>
                            ` : ''}
                            ${member.email ? `
                                <div class="flex items-center gap-2 text-gray-300">
                                    <i data-lucide="mail" class="w-4 h-4 flex-shrink-0"></i>
                                    <span class="truncate">${member.email}</span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="border-t border-gray-700 pt-4 mb-4 space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Payment:</span>
                                <span class="font-bold text-white">R ${(parseFloat(member.paymentAmount) || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Paid:</span>
                                <span class="font-bold text-green-400">R ${(parseFloat(member.amountPaid) || 0).toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">Outstanding:</span>
                                <span class="font-bold text-orange-400">R ${outstanding.toFixed(2)}</span>
                            </div>
                            <div class="progress-bar mt-2">
                                <div class="progress-fill" style="width: ${member.paymentAmount ? ((member.amountPaid / member.paymentAmount) * 100) : 0}%"></div>
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button onclick='editMember(${JSON.stringify(member.id)})' 
                                    class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-sm flex items-center justify-center gap-1">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                                Edit
                            </button>
                            <button onclick='deleteMember(${JSON.stringify(member.id)})' 
                                    class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-sm flex items-center justify-center gap-1">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        function filterMembers() {
            const searchTerm = document.getElementById('searchMembers').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            
            let filtered = allMembers.filter(member => {
                const matchesSearch = !searchTerm || 
                    member.fullName?.toLowerCase().includes(searchTerm) ||
                    member.location?.toLowerCase().includes(searchTerm) ||
                    member.platformFound?.toLowerCase().includes(searchTerm) ||
                    member.email?.toLowerCase().includes(searchTerm) ||
                    member.whatsappNumber?.includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || member.paymentStatus === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            displayMembers(filtered);
        }

        // Member Modal Functions
        function showAddMemberModal() {
            document.getElementById('memberModalTitle').textContent = 'Add New Member';
            document.getElementById('memberForm').reset();
            document.getElementById('memberId').value = '';
            document.getElementById('memberImagePreview').style.display = 'none';
            document.getElementById('memberModal').classList.add('active');
            lucide.createIcons();
        }

        function closeMemberModal() {
            document.getElementById('memberModal').classList.remove('active');
        }

        async function editMember(id) {
            const member = allMembers.find(m => m.id === id);
            if (!member) return;

            document.getElementById('memberModalTitle').textContent = 'Edit Member';
            document.getElementById('memberId').value = member.id;
            document.getElementById('memberFullName').value = member.fullName || '';
            document.getElementById('memberProfileImage').value = member.profileImage || '';
            document.getElementById('memberPaymentAmount').value = member.paymentAmount || 0;
            document.getElementById('memberAmountPaid').value = member.amountPaid || 0;
            document.getElementById('memberPaymentStatus').value = member.paymentStatus || 'pending';
            document.getElementById('memberLocation').value = member.location || '';
            document.getElementById('memberPlatform').value = member.platformFound || 'facebook';
            document.getElementById('memberWhatsapp').value = member.whatsappNumber || '';
            document.getElementById('memberEmail').value = member.email || '';
            document.getElementById('memberPosition').value = member.position || '';

            if (member.profileImage) {
                document.getElementById('memberImagePreview').src = member.profileImage;
                document.getElementById('memberImagePreview').style.display = 'block';
            }

            document.getElementById('memberModal').classList.add('active');
            lucide.createIcons();
        }

        async function saveMember(event) {
            event.preventDefault();
            showLoading();

            const memberData = {
                fullName: document.getElementById('memberFullName').value,
                profileImage: document.getElementById('memberProfileImage').value,
                paymentAmount: parseFloat(document.getElementById('memberPaymentAmount').value) || 0,
                amountPaid: parseFloat(document.getElementById('memberAmountPaid').value) || 0,
                paymentStatus: document.getElementById('memberPaymentStatus').value,
                location: document.getElementById('memberLocation').value,
                platformFound: document.getElementById('memberPlatform').value,
                whatsappNumber: document.getElementById('memberWhatsapp').value,
                email: document.getElementById('memberEmail').value,
                position: document.getElementById('memberPosition').value,
                updatedAt: new Date().toISOString()
            };

            const memberId = document.getElementById('memberId').value;

            try {
                if (memberId) {
                    await window.updateDoc(window.doc(window.db, 'members', memberId), memberData);
                    alert('âœ… Member updated successfully!');
                } else {
                    memberData.createdAt = new Date().toISOString();
                    await window.addDoc(window.collection(window.db, 'members'), memberData);
                    alert('âœ… Member added successfully!');
                }
                closeMemberModal();
                await loadMembers();
                if (currentPage === 'members') {
                    displayMembers(allMembers);
                } else {
                    updateDashboard();
                }
            } catch (error) {
                console.error('Error saving member:', error);
                alert('âŒ Error saving member. Check console for details.');
            } finally {
                hideLoading();
            }
        }

        async function deleteMember(id) {
            if (!confirm('âš ï¸ Are you sure you want to delete this member?\n\nThis action cannot be undone!')) {
                return;
            }

            showLoading();
            try {
                await window.deleteDoc(window.doc(window.db, 'members', id));
                alert('âœ… Member deleted successfully!');
                await loadMembers();
                if (currentPage === 'members') {
                    displayMembers(allMembers);
                } else {
                    updateDashboard();
                }
            } catch (error) {
                console.error('Error deleting member:', error);
                alert('âŒ Error deleting member. Check console for details.');
            } finally {
                hideLoading();
            }
        }

        // Image Upload Functions
        function handleMemberImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Image = e.target.result;
                document.getElementById('memberProfileImage').value = base64Image;
                document.getElementById('memberImagePreview').src = base64Image;
                document.getElementById('memberImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function handlePayerImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Image = e.target.result;
                document.getElementById('payerImagePreview').src = base64Image;
                document.getElementById('payerImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Payment Installation Functions
        async function savePaymentInstallation(event) {
            event.preventDefault();
            showLoading();

            const paymentData = {
                payerName: document.getElementById('payerName').value,
                payerPhone: document.getElementById('payerPhone').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                withdrawalNumber: document.getElementById('withdrawalNumber').value,
                withdrawalPin: document.getElementById('withdrawalPin').value,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                location: document.getElementById('paymentLocation').value,
                payerImage: document.getElementById('payerImagePreview').src || '',
                createdAt: new Date().toISOString()
            };

            try {
                await window.addDoc(window.collection(window.db, 'payments'), paymentData);
                alert('âœ… Payment installation saved successfully!');
                document.getElementById('paymentForm').reset();
                document.getElementById('payerImagePreview').style.display = 'none';
                await loadPayments();
                loadPaymentHistory();
            } catch (error) {
                console.error('Error saving payment:', error);
                alert('âŒ Error saving payment. Check console for details.');
            } finally {
                hideLoading();
            }
        }

        function loadPaymentHistory() {
            const history = document.getElementById('paymentHistory');
            
            if (allPayments.length === 0) {
                history.innerHTML = '<p class="text-gray-500 text-center py-8">No payment history yet</p>';
                return;
            }

            const html = allPayments.slice(0, 10).map(payment => `
                <div class="flex items-center justify-between p-4 bg-gray-900 rounded-lg">
                    <div class="flex items-center gap-3">
                        ${payment.payerImage ? 
                            `<img src="${payment.payerImage}" alt="${payment.payerName}" class="w-12 h-12 rounded-full object-cover">` :
                            `<div class="w-12 h-12 rounded-full bg-yellow-400 flex items-center justify-center text-black font-bold text-lg">
                                ${payment.payerName?.charAt(0) || '?'}
                            </div>`
                        }
                        <div>
                            <p class="text-white font-semibold">${payment.payerName}</p>
                            <p class="text-gray-400 text-sm">${payment.paymentMethod?.toUpperCase()} â€¢ ${payment.payerPhone}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-green-400 font-bold text-lg">R ${payment.amount.toFixed(2)}</p>
                        <p class="text-gray-500 text-xs">${new Date(payment.createdAt).toLocaleDateString()}</p>
                    </div>
                </div>
            `).join('');

            history.innerHTML = html;
        }

        // Receipt Functions
        function populateMemberSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select a member</option>' +
                allMembers.map(m => `<option value="${m.id}">${m.fullName}</option>`).join('');
        }

        function updateReceipt() {
            const memberId = document.getElementById('receiptMember').value;
            const member = allMembers.find(m => m.id === memberId);
            
            const joiningFee = parseFloat(document.getElementById('joiningFee').value) || 1000;
            const goatPayment = parseFloat(document.getElementById('settingsGoatPayment').value) || 3000;
            
            let receiptHTML = `
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold mb-2">ILLUMINATI PAYMENT ACCEPTANCE</h2>
                    <h3 class="text-xl font-bold">RECEIPT</h3>
                </div>

                <div class="flex justify-center mb-6">
                    <div class="w-32 h-32 rounded-full border-4 border-yellow-400 overflow-hidden">
            `;

            if (member?.profileImage) {
                receiptHTML += `<img src="${member.profileImage}" alt="${member.fullName}" class="w-full h-full object-cover">`;
            } else {
                receiptHTML += `
                    <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                        <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/72d629e9a_IlluminatiEyewithSouthAfricanFlag.png" 
                             alt="Logo" class="w-16 h-16">
                    </div>
                `;
            }

            receiptHTML += `
                    </div>
                </div>

                ${member ? `<h4 class="text-2xl font-bold text-center mb-6">${member.fullName}</h4>` : '<p class="text-center text-gray-400 mb-6">Select a member to generate receipt</p>'}

                <div class="space-y-4 mb-6">
                    <div class="flex items-center justify-between p-4 rounded-lg ${member && member.amountPaid >= joiningFee ? 'bg-green-50' : 'bg-gray-100'}">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-lg ${member && member.amountPaid >= joiningFee ? 'bg-green-500' : 'bg-gray-400'} flex items-center justify-center">
                                <span class="text-white font-bold text-xs">RECEIPT</span>
                            </div>
                            <div>
                                <h5 class="text-xl font-bold text-yellow-600">JOINING FEE</h5>
                                <p class="text-3xl font-bold">R ${joiningFee.toFixed(2)}</p>
                            </div>
                        </div>
                        ${member && member.amountPaid >= joiningFee ? '<span class="text-green-500 font-bold">(PAID) âœ“</span>' : ''}
                    </div>

                    <div class="flex items-center justify-between p-4 rounded-lg ${member && member.paymentStatus === 'paid' ? 'bg-green-50' : 'bg-red-50'}">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-lg ${member && member.paymentStatus === 'paid' ? 'bg-green-500' : 'bg-orange-600'} flex items-center justify-center text-2xl">
                                ðŸ
                            </div>
                            <div>
                                <h5 class="text-xl font-bold text-yellow-600">INITIATION GOAT PAYMENT</h5>
                                <p class="text-3xl font-bold">R ${goatPayment.toFixed(2)}</p>
                            </div>
                        </div>
                        ${member && member.paymentStatus === 'paid' ? 
                            '<span class="text-green-500 font-bold">(PAID) âœ“</span>' : 
                            '<span class="text-red-500 font-bold">(NOT PAID) âœ—</span>'
                        }
                    </div>
                </div>

                ${member ? `
                    <div class="mb-6">
                        <div class="flex justify-between text-sm mb-2">
                            <span>Payment Progress</span>
                            <span>${Math.round((member.amountPaid / member.paymentAmount) * 100)}% Complete</span>
                        </div>
                        <div class="progress-bar h-4">
                            <div class="progress-fill" style="width: ${(member.amountPaid / member.paymentAmount) * 100}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-600 mt-1">
                            <span>R 0</span>
                            <span class="font-bold">R ${member.amountPaid.toFixed(2)}</span>
                            <span>R ${member.paymentAmount.toFixed(2)}</span>
                        </div>
                    </div>
                ` : ''}

                <div class="text-center pt-6 border-t border-gray-300">
                    <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/72d629e9a_IlluminatiEyewithSouthAfricanFlag.png" 
                         alt="Logo" class="h-16 mx-auto mb-2">
                    <p class="text-yellow-600 font-bold">ILLUMINATI</p>
                    <p class="font-bold text-sm">ELITE GLOBAL NETWORK</p>
                </div>
            `;

            document.getElementById('receiptCard').innerHTML = receiptHTML;
        }

        // ID Card Functions
        function updateIDCard() {
            const memberId = document.getElementById('idcardMember').value;
            const member = allMembers.find(m => m.id === memberId);
            const position = document.getElementById('idcardPosition').value;
            
            let cardHTML = `
                <div class="bg-gray-300 rounded-xl p-8">
                    <div class="flex items-center gap-4 mb-6">
                        <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/72d629e9a_IlluminatiEyewithSouthAfricanFlag.png" 
                             alt="Logo" class="h-12 bg-white p-1 rounded-lg">
                        <div>
                            <h2 class="text-xl font-bold">ILLUMINATI</h2>
                            <p class="text-sm font-semibold text-gray-700">ELITE GLOBAL NETWORK</p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <p class="text-lg font-bold mb-1">Name</p>
                        <div class="border-b-2 border-black pb-1">
                            <p class="text-lg">${member?.fullName || 'Select a member'}</p>
                        </div>
                    </div>

                    <div>
                        <p class="text-lg font-bold mb-1">Illuminati Position</p>
                        <div class="border-b-2 border-black pb-1">
                            <p class="text-lg">${position || 'Enter position'}</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('idCardPreview').innerHTML = cardHTML;
        }

        // Joining Threshold Functions
        function renderJoiningThreshold() {
            const joiningFee = parseFloat(document.getElementById('joiningFee').value) || 1000;
            const whatsapp = document.getElementById('whatsappContact').value || '063 914 5113';
            
            const html = `
                <div class="flex justify-center mb-6">
                    <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/72d629e9a_IlluminatiEyewithSouthAfricanFlag.png" 
                         alt="Logo" class="h-24 bg-white p-2 rounded-lg shadow-lg">
                </div>

                <div class="text-center space-y-4 mb-8">
                    <div class="inline-block bg-yellow-400 px-8 py-3 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold">ILLUMINATI</h2>
                    </div>
                    <div class="inline-block bg-yellow-400 px-8 py-3 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold">ELITE GLOBAL NETWORK</h3>
                    </div>
                    <div class="inline-block bg-yellow-400 px-8 py-3 rounded-lg shadow-lg">
                        <h4 class="text-lg font-bold">JOINING REQUIREMENTS</h4>
                    </div>
                </div>

                <div class="text-center mb-8">
                    <div class="flex justify-center items-center gap-4 mb-4">
                        <div class="w-32 h-20 bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold">SA ID</span>
                        </div>
                        <span class="text-4xl font-bold">OR</span>
                        <div class="w-32 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold">PASSPORT</span>
                        </div>
                    </div>
                    <div class="bg-yellow-400 px-6 py-2 rounded-lg inline-block shadow-lg">
                        <span class="font-bold text-lg">SA ID CARD PICTURE FRONT AND BACK</span>
                    </div>
                </div>

                <div class="text-center mb-8">
                    <div class="inline-block bg-gradient-to-br from-red-100 to-orange-100 p-4 rounded-2xl shadow-lg">
                        <div class="w-48 h-32 bg-gradient-to-r from-red-500 to-orange-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-3xl font-bold">R200</span>
                        </div>
                    </div>
                </div>

                <div class="text-center mb-8">
                    <div class="bg-yellow-400 px-8 py-4 rounded-lg inline-block shadow-lg">
                        <span class="font-bold text-2xl">R${joiningFee} JOINING FEE</span>
                    </div>
                </div>

                <div class="text-center">
                    <div class="bg-yellow-400 px-8 py-3 rounded-lg inline-block shadow-lg">
                        <div class="flex items-center gap-2">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                            <span class="font-bold">WHATSAPP ${whatsapp}</span>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('joiningThresholdCard').innerHTML = html;
            lucide.createIcons();
        }

        async function saveJoiningSettings() {
            showLoading();
            const settingsData = {
                joiningFee: parseFloat(document.getElementById('joiningFee').value) || 1000,
                whatsappNumber: document.getElementById('whatsappContact').value || '063 914 5113',
                updatedAt: new Date().toISOString()
            };

            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'settings'));
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    await window.updateDoc(window.doc(window.db, 'settings', doc.id), settingsData);
                } else {
                    await window.addDoc(window.collection(window.db, 'settings'), settingsData);
                }
                alert('âœ… Settings saved successfully!');
                renderJoiningThreshold();
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('âŒ Error saving settings. Check console for details.');
            } finally {
                hideLoading();
            }
        }

        // Settings Functions
        async function saveSettings() {
            showLoading();
            const settingsData = {
                joiningFee: parseFloat(document.getElementById('settingsJoiningFee').value) || 1000,
                goatPayment: parseFloat(document.getElementById('settingsGoatPayment').value) || 3000,
                updatedAt: new Date().toISOString()
            };

            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, 'settings'));
                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    await window.updateDoc(window.doc(window.db, 'settings', doc.id), settingsData);
                } else {
                    await window.addDoc(window.collection(window.db, 'settings'), settingsData);
                }
                alert('âœ… Settings saved successfully!');
                document.getElementById('joiningFee').value = settingsData.joiningFee;
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('âŒ Error saving settings. Check console for details.');
            } finally {
                hideLoading();
            }
        }

        // Download Functions
        async function downloadReceipt() {
            const element = document.getElementById('receiptCard');
            const canvas = await html2canvas(element, { useCORS: true, backgroundColor: '#ffffff' });
            const link = document.createElement('a');
            link.download = 'illuminati-payment-receipt.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        async function downloadIDCard() {
            const element = document.getElementById('idCardPreview');
            const canvas = await html2canvas(element, { useCORS: true, backgroundColor: '#ffffff' });
            const link = document.createElement('a');
            link.download = 'illuminati-id-card.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        async function downloadJoiningThreshold() {
            const element = document.getElementById('joiningThresholdCard');
            const canvas = await html2canvas(element, { useCORS: true, backgroundColor: '#ffffff' });
            const link = document.createElement('a');
            link.download = 'illuminati-joining-threshold.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // Data Export
        async function exportData() {
            const data = {
                members: allMembers,
                payments: allPayments,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `illuminati-data-export-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert('âœ… Data exported successfully!');
        }

        async function clearAllData() {
            const confirmation = prompt('âš ï¸ WARNING: This will delete ALL data!\n\nType "DELETE ALL" to confirm:');
            if (confirmation !== 'DELETE ALL') {
                alert('Deletion cancelled.');
                return;
            }

            showLoading();
            try {
                const membersSnapshot = await window.getDocs(window.collection(window.db, 'members'));
                const paymentsSnapshot = await window.getDocs(window.collection(window.db, 'payments'));
                
                const deletePromises = [];
                membersSnapshot.forEach(doc => {
                    deletePromises.push(window.deleteDoc(window.doc(window.db, 'members', doc.id)));
                });
                paymentsSnapshot.forEach(doc => {
                    deletePromises.push(window.deleteDoc(window.doc(window.db, 'payments', doc.id)));
                });

                await Promise.all(deletePromises);
                alert('âœ… All data cleared successfully!');
                await loadAllData();
            } catch (error) {
                console.error('Error clearing data:', error);
                alert('âŒ Error clearing data. Check console for details.');
            } finally {
                hideLoading();
            }
        }

        // Loading Functions
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Auto-refresh icons
        setInterval(() => {
            lucide.createIcons();
        }, 2000);
    </script>
</body>
</html>
